<!doctype html>
<html lang='en'>
<head>
 <title>notes with crypto auth</title>
 <meta charset='utf-8' />
 <meta name='viewport' content='width=device-width, initial-scale=1' />
</head>
<body>
<script type='module'>
import{customImport}from'./customImport.js';
(async(
 name,password
)=>{
 customImport.assignImportMap({
 'utils':'./utils.js',
 'test/customImport/stub':'./test/customImport/stub.js',
 'test/customImport':'test/customImport/index.js',
 'ui/auth':'./ui/auth.js',
 'log':'./log.js',
 'test/log':'./test/log.js',
 'crypto/auth':'./crypto/auth.js',
 'test/crypto/auth':'./test/crypto/auth.js',
 'tests':'./test/index.js'
 });

 customImport.assignImportMap({
 'preact':'https://cdn.jsdelivr.net/npm/preact/dist/preact.module.js',
 'preact/hooks':'https://cdn.jsdelivr.net/npm/preact/hooks/dist/hooks.module.js',
 'htm':'https://unpkg.com/htm?module'
 });
 globalThis.customImport=customImport;
 const{$,h,p,wait,throttle}=await(customImport('utils'));

 const[
  {createMultiStateLoginForm},
  {
   hash,check,
   cryptoRegister,
   cryptoLogin,
   cryptoStore
  }
 ]=await(Promise.all([
  customImport('ui/auth'),
  customImport('crypto/auth')
 ]));

const{
 form,
 setCheckStatusHandler,
 setSignInHandler,
 setSignUpHandler,
 setLogoutHandler
}=createMultiStateLoginForm('');
const[bd,dv,ta,
 cmdpanel,btnEval,
 btnUpdate,btnAppend,
 btnLoad,btnStore
]=[
 $('body'),
 h('div'),
 h('textarea'),
 h('div'),h('button'),
 h('button'),h('button'),
 h('button'),h('button')
];
form.style.float='right';
p(bd,form);

dv.style.clear='both';
p(bd,dv);

ta.style.width='70%';
ta.style.height='300px';
p(bd,ta);

cmdpanel.style.display='flex';
cmdpanel.style.justifyContent='space-between';

btnLoad.innerHTML='load';
p(cmdpanel,btnLoad);
btnEval.innerHTML='eval';
p(cmdpanel,btnEval);
btnUpdate.innerHTML='update';
p(cmdpanel,btnUpdate);
btnAppend.innerHTML='append';
p(cmdpanel,btnAppend);
btnStore.innerHTML='store';
p(cmdpanel,btnStore);

p(bd,cmdpanel);


const dst={
 name:'public@simplenotes',
 title:'',
 content:'',
 autoeval:false,
 timestamp:Date.now()
};
let st=Object.assign({},dst);
if(localStorage.state){
  Object.assign(st,
   JSON.parse(localStorage.state)
  );
}
let pst={};

const updaters={
 title:({title,content})=>{
  ta.value=`${title}\n${content}`;
 },content:({title,content})=>{
  ta.value=`${title}\n${content}`;
 }
};
const update=st=>{
 Object.entries(updaters)
 .filter(([k])=>st[k]!==pst[k])
 .forEach(([k,f])=>f(st))
// ta.value=`${title}\n${content}`;
};

setCheckStatusHandler(async(
 login,nm,isEmpty,isExist,isOnline
)=>{
 nm=login+'@simplenotes';
 isOnline=navigator.onLine;
 //need check in local storage
 if(isOnline){
  isEmpty=await(check(
   await(hash(nm))
  ));
 }else{
  isEmpty=true;
 }
 isExist=!isEmpty;
 return{isExist,isOnline};
});
setSignInHandler(async(
 login,pass,userObj,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 userObj=await(cryptoLogin(
  name,password
 ));
 isOk=!!userObj;
 if(isOk){
  alert(JSON.stringify(userObj));
  Object.assign(st,dst,userObj);
  update(st);
  if(st.autoeval)try{
   eval(st.content);
  }catch(e){alert(e)};
 }
 return(isOk);
});
setSignUpHandler(async(
 login,pass,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 Object.assign(st,dst,{
  name,
  timestamp:Date.now()
 });
 isOk=await(cryptoRegister(
  name,password,st
 ));
 update(st);
 return(isOk);
});
setLogoutHandler(()=>{
 alert('logout');
 name='';
 password='';
 Object.assign(st,dst);
 update(st);
 return(true);
});

update(st);
if(st.autoeval)try{
 eval(st.content);
}catch(e){alert(e)};

const updateButtons=(
 {isThrottle},isOffline,mustHide
)=>{
 isOffline=!navigator.onLine;
 mustHide=isThrottle||isOffline;
 btnLoad.disabled=mustHide;
 btnStore.disabled=mustHide;
};
ononline=()=>updateButtons(st);
onoffline=()=>updateButtons(st);

ta.oninput=throttle(async(e)=>{
 //alert(e.target.value);

 const[_,title,content]=e.target.value
 .match(/^(.+)\n?([\s\S]*)$/);
 Object.assign(st,{title,content});
 st.autoeval=title.split(' ')
 .includes('autoeval');
 
 localStorage.state=
  JSON.stringify(st);
},5000,{
 beforeEach:()=>{
  st.isThrottle=true;
  updateButtons(st);
 },
 afterLast:()=>{
  st.isThrottle=false;
  updateButtons(st);
 }
});


btnStore.onclick=async(txt,r)=>{
  r=await(cryptoStore(
   name,password,st
  ));
  alert(r);
};
btnEval.onclick=e=>{
 eval(st.content);
};

//await(customImport('tests'));
})();</script>
</body>
</html>

<!doctype html>
<html lang='en'>
<head>
 <title>notes with crypto auth</title>
 <meta charset='utf-8' />
 <meta name='viewport' content='width=device-width, initial-scale=1' />
</head>
<body>
<script type='module'>
import{customImport}from'./customImport.js';

(async(
 name='public@simplenotes',
 password='pass',
 txt='',items=[],
 els,index
)=>{try{
 customImport.assignImportMap({
 'utils':'./utils.js',
 'test/customImport/stub':'./test/customImport/stub.js',
 'test/customImport':'test/customImport/index.js',
 'ui/auth':'./ui/auth.js',
 'log':'./log.js',
 'test/log':'./test/log.js',
 'crypto/auth':'./crypto/auth.js',
 'test/crypto/auth':'./test/crypto/auth.js',
 'tests':'./test/index.js'
 });

 customImport.assignImportMap({
 'preact':'https://cdn.jsdelivr.net/npm/preact/dist/preact.module.js',
 'preact/hooks':'https://cdn.jsdelivr.net/npm/preact/hooks/dist/hooks.module.js',
 'htm':'https://unpkg.com/htm?module'
 });
 globalThis.customImport=customImport;
 const{$,h,p,wait,throttle}=await(customImport('utils'));

 const[
  {createMultiStateLoginForm},
  {
   hash,check,
   cryptoRegister,
   cryptoLogin,
   cryptoStore,
   cryptoLoad,
   cryptoLocalStore,
   cryptoLocalLoad
  }
 ]=await(Promise.all([
  customImport('ui/auth'),
  customImport('crypto/auth')
 ]));

const{
 form,
 setCheckStatusHandler,
 setSignInHandler,
 setSignUpHandler,
 setLogoutHandler
}=createMultiStateLoginForm();
const[bd,dv,ta,
 cmdpanel,itemsContainer
]=[
 $('body'),
 h('div'),
 h('textarea'),
 h('div'),h('div')
];
form.style.float='right';
p(bd,form);

dv.style.clear='both';
p(bd,dv);

ta.style.width='70%';
ta.style.height='300px';
p(bd,ta);

cmdpanel.style.display='flex';
cmdpanel.style.justifyContent='space-between';

const[btnEval,
 btnUpdate,btnAppend,
 btnLoad,btnStore
]=[
 h('button'),
 h('button'),h('button'),
 h('button'),h('button')
];
btnLoad.innerHTML='load';
p(cmdpanel,btnLoad);
btnEval.innerHTML='eval';
p(cmdpanel,btnEval);
btnUpdate.innerHTML='update';
btnUpdate.disabled=true;
p(cmdpanel,btnUpdate);
btnAppend.innerHTML='append';
p(cmdpanel,btnAppend);
btnStore.innerHTML='store';
p(cmdpanel,btnStore);

p(bd,cmdpanel);
p(bd,itemsContainer);

const updateText=
txt=>{ta.value=txt};

const updateButtons=(
 mustHide
)=>{
 mustHide=!navigator.onLine;
 btnLoad.disabled=mustHide;
 btnStore.disabled=mustHide;
};

const appendItem=(
 {title,content},
 el=h('div'),
 titl=h('b'),
 cont=h('pre')
)=>{try{
 titl.innerHTML=title;
 cont.style.margin=0;
 cont.innerHTML=content;
 p(el,titl);
 p(el,cont);
 p(itemsContainer,el);
}catch(e){alert(e)}};

const updateItem=(
 {title,content},i,
 el=itemsContainer.querySelector(
  `div:nth-of-type(${i+1})`
 ),
 titl=h('b'),
 cont=h('pre')
)=>{try{
 el.innerHTML='';
 titl.innerHTML=title;
 cont.style.margin=0;
 cont.innerHTML=content;
 p(el,titl);
 p(el,cont);
}catch(e){alert(e)}};
const updateItems=items=>{
 itemsContainer.innerHTML='';
 items.forEach(
  item=>appendItem(item)
 );
};
const createItem=(
 txt='',
 arr=txt.split('\n'),
 title=arr.shift(),
 content=arr.join('\n'),
 autoeval=title.split(' ')
 .includes('autoeval'),
 timestamp=Date.now()
)=>(
 {title,content,autoeval,timestamp}
);

setCheckStatusHandler(async(
 login,nm,isEmpty,isExist,isOnline
)=>{
 nm=login+'@simplenotes';
 isOnline=navigator.onLine;
 //need check in local storage
 if(isOnline){
  isEmpty=await(check(
   await(hash(nm))
  ));
 }else{
  isEmpty=true;
 }
 isExist=!isEmpty;
 return{isExist,isOnline};
});
setSignInHandler(async(
 login,pass,userObj,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 userObj=await(cryptoLogin(
  name,password
 ));
 isOk=!!userObj;
 if(isOk){
  alert(JSON.stringify(userObj));
  items=userObj;
  updateItems(items);
  items.forEach(({
   title,content,autoeval
  })=>{
   if(autoeval)try{
    eval(`${title}\n${content}`);
   }catch(e){alert(e)};
  });
 }
 return(isOk);
});
setSignUpHandler(async(
 login,pass,item,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 isOk=await(cryptoRegister(
  name,password,items
 ));
 return(isOk);
});
setLogoutHandler(()=>{
 alert('logout');
 name='public@simplenotes';
 password='pass';
 txt='';
 updateText(txt);
 items=[];
 updateItems(items);
 return(true);
});

if(localStorage.txt){
  txt=localStorage.txt;
}
try{
 alert(name)
 alert(password)
 items=await(cryptoLocalLoad(
  'items_',name,password
 ))||[];
 alert(items);
}catch(e){alert(e)}
 //if(localStorage.items){
 //items=JSON.parse(localStorage.items);
//}

updateButtons();
updateText(txt);
updateItems(items);

els=Array.from(
 itemsContainer.childNodes
);
els.forEach((el,i,ar,
 btn=h('button')
)=>{
 btn.innerHTML='^';
 el.firstChild.prepend(btn);
 btn.onclick=e=>{
  index=i;
  ta.value=el.innerText.substr(1);
  alert(index);
  btnUpdate.disabled=false;
 };
});

items.forEach(({
 title,content,autoeval
})=>{
 if(autoeval)try{
  eval(`${title}\n${content}`);
 }catch(e){alert(e)};
});

ononline=updateButtons;
onoffline=updateButtons;

ta.oninput=async(e)=>{
 txt=e.target.value;
 localStorage.txt=txt;
};

btnStore.onclick=async(e,r)=>{
 r=await(cryptoStore(
  name,password,items
 ));
 alert(r);
};
btnLoad.onclick=async(e)=>{
 items=await(cryptoLoad(
  name,password
 ));
 alert(JSON.stringify(items));
 updateItems(items);
};
btnEval.onclick=e=>{
 eval(txt);
};
btnAppend.onclick=async(e,item)=>{
 item=createItem(txt);
 alert(JSON.stringify(item));
 items.push(item);
 await(cryptoLocalStore(
  'items_',name,password,items
 ));
 //localStorage.items=JSON
 //.stringify(items);
 appendItem(item);
 //updateItems();
};
btnUpdate.onclick=async(e,txt,item)=>{
 alert(index);
 txt=ta.value;
 item=createItem(txt);
 alert(JSON.stringify(item));
 items[i]=item;
 await(cryptoLocalStore(
  'items_',name,password,items
 ));
 updateItem(item,index);
};

//await(customImport('tests'));
}catch(e){alert(e)}})();
</script>
</body>
</html>

<!doctype html>
<html lang='en'>
<head>
 <title>notes with crypto auth</title>
 <meta charset='utf-8' />
 <meta name='viewport' content='width=device-width, initial-scale=1' />
</head>
<body>
<script type='module'>
import{customImport}from'./customImport.js';
(async(
 name,password,txt='',items=[]
)=>{
 customImport.assignImportMap({
 'utils':'./utils.js',
 'test/customImport/stub':'./test/customImport/stub.js',
 'test/customImport':'test/customImport/index.js',
 'ui/auth':'./ui/auth.js',
 'log':'./log.js',
 'test/log':'./test/log.js',
 'crypto/auth':'./crypto/auth.js',
 'test/crypto/auth':'./test/crypto/auth.js',
 'tests':'./test/index.js'
 });

 customImport.assignImportMap({
 'preact':'https://cdn.jsdelivr.net/npm/preact/dist/preact.module.js',
 'preact/hooks':'https://cdn.jsdelivr.net/npm/preact/hooks/dist/hooks.module.js',
 'htm':'https://unpkg.com/htm?module'
 });
 globalThis.customImport=customImport;
 const{$,h,p,wait,throttle}=await(customImport('utils'));

 const[
  {createMultiStateLoginForm},
  {
   hash,check,
   cryptoRegister,
   cryptoLogin,
   cryptoStore
  }
 ]=await(Promise.all([
  customImport('ui/auth'),
  customImport('crypto/auth')
 ]));

const{
 form,
 setCheckStatusHandler,
 setSignInHandler,
 setSignUpHandler,
 setLogoutHandler
}=createMultiStateLoginForm('');
const[bd,dv,ta,
 cmdpanel,itemsContainer
]=[
 $('body'),
 h('div'),
 h('textarea'),
 h('div'),h('div')
];
form.style.float='right';
p(bd,form);

dv.style.clear='both';
p(bd,dv);

ta.style.width='70%';
ta.style.height='300px';
p(bd,ta);

cmdpanel.style.display='flex';
cmdpanel.style.justifyContent='space-between';

const[btnEval,
 btnUpdate,btnAppend,
 btnLoad,btnStore
]=[
 h('button'),
 h('button'),h('button'),
 h('button'),h('button')
];
btnLoad.innerHTML='load';
p(cmdpanel,btnLoad);
btnEval.innerHTML='eval';
p(cmdpanel,btnEval);
btnUpdate.innerHTML='update';
p(cmdpanel,btnUpdate);
btnAppend.innerHTML='append';
p(cmdpanel,btnAppend);
btnStore.innerHTML='store';
p(cmdpanel,btnStore);

p(bd,cmdpanel);
p(bd,itemsContainer);

const updateText=
txt=>{ta.value=txt};

const updateButtons=(
 mustHide
)=>{
 mustHide=!navigator.onLine;
 btnLoad.disabled=mustHide;
 btnStore.disabled=mustHide;
};

const appendItem=({
 title,content
},el,titl,cont)=>{
 el=h('div');
 titl=h('h4');
 cont=h('pre');
 titl.innerHTML=title;
 cont.innerHTML=content;
 p(el,titl);
 p(el,cont);
 p(itemsContainer,el);
};

const updateItems=items=>{

};

const createItem=(
 txt='',arr,title,content,autoeval,timestamp
)=>{
 arr=txt.split('\n');
 title=arr.shift();
 content=arr.join('\n');
 autoeval=title.split(' ')
 .includes('autoeval');
 timestamp=Date.now();
 return{title,content,autoeval,timestamp};
};

setCheckStatusHandler(async(
 login,nm,isEmpty,isExist,isOnline
)=>{
 nm=login+'@simplenotes';
 isOnline=navigator.onLine;
 //need check in local storage
 if(isOnline){
  isEmpty=await(check(
   await(hash(nm))
  ));
 }else{
  isEmpty=true;
 }
 isExist=!isEmpty;
 return{isExist,isOnline};
});
setSignInHandler(async(
 login,pass,userObj,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 userObj=await(cryptoLogin(
  name,password
 ));
 isOk=!!userObj;
 if(isOk){
  alert(JSON.stringify(userObj));
  const{
   title,content,autoeval
  }=userObj;
  txt=`${title}\n${content}`;
  updateText(txt);
  if(autoeval)try{
   eval(txt);
  }catch(e){alert(e)};
 }
 return(isOk);
});
setSignUpHandler(async(
 login,pass,item,isOk
)=>{
 name=login+'@simplenotes';
 password=pass;
 item=createItem(txt);
 isOk=await(cryptoRegister(
  name,password,item
 ));
 return(isOk);
});
setLogoutHandler(()=>{
 alert('logout');
 name='';
 password='';
 txt='';
 updateText();
 return(true);
});

updateButtons();
if(localStorage.txt){
  txt=localStorage.txt;
}
updateText(txt);
item=createItem(txt);
if(item.autoeval)try{
 eval(txt);
}catch(e){alert(e)};

ononline=updateButtons;
onoffline=updateButtons;

ta.oninput=async(e)=>{
 txt=e.target.value;
 localStorage.txt=txt;
};

btnStore.onclick=async(item,r)=>{
  item=createItem(txt);
  r=await(cryptoStore(
   name,password,item
  ));
  alert(r);
};
btnEval.onclick=e=>{
 eval(txt);
};
btnUppend.onclick=(e,item)=>{
 item=createItem(txt);
 appendItem(item);
 //items.push(item);
 //updateItems();
};

//await(customImport('tests'));
})();</script>
</body>
</html>
